trigger:
- staging

pool:
  vmImage: ubuntu-latest

variables:
  - name: Deploy
    value: EC2

stages:
- stage: CI
  displayName: Pipeline de Integração Contínua
  jobs:
    - job: Pipeline_CI
      displayName: Execução da Pipeline CI
      steps:
      - task: NodeTool@0
        displayName: Intalação da versão correta do NodeJs
        inputs:
          versionSpec: '14.19.3'
    
    - job: Publish
      displayName: Construção e Publicação
      dependsOn: Pipeline_CI
      steps:
      - task: Docker@2
        inputs:
          containerRegistry: 'Thandi13_Docker_Connection'
          repository: 'thandi13/simple-chat'
          command: 'buildAndPush'
          Dockerfile: 'Dockerfile'
          tags: |
            v-ADO-$(Build.BuildId)
            latest
- stage: CD
  displayName: Pipeline de Deploy Contínuo
  dependsOn: CI
  jobs: 
  - job: SSH
    displayName: SSH na instância do EC2 
    steps:
    - task: SSH@0
      inputs:
        sshEndpoint: 'simple_chat_ec2_ssh'
        runOptions: 'commands'
        commands: |
          sudo yum update -y
          
          sudo yum install -y docker
          
          sudo usermod -aG docker ec2-user
          
          docker run hello-world
        readyTimeout: '100000'